# Прикладная логика для боевого сервера

## Статус

На рассмотрении

## Текущее состояние

Текущий сервер (RealtimeMatches) позволяет клиентам обмениваться между собой данными. Используется протокол UDP, есть
разные гарантии доставки. Обмен на основе создания объектов с полями разных типов, клиент может создавать серверные
объекты, менять на них данные, все это синхронизируется с другими клиентами. Есть система прав, есть понятие шаблона
объекта. Есть сложные типы данных - типа CompareAndSet и Counter.

## Проблематика

Нет возможности реализовать прикладную логику для конкретной игры, например добавить античиты.
Конечно, на сложных типах данных можно реализовать большую часть логики вообще без программирования на стороне
сервера и к этому неплохо бы стремиться, однако иногда это бывает достаточно сложно или невозможно, поэтому такая
возможность необходима.

## Варианты решения

В рамках данного документа мы рассматриваем вариант Unity Dedicated Server (UDS) для реализации прикладной логики.
Скорее всего разработанное решение позволит подключать сервера написанные на других языках/подходах, но основная наша
задача в использовании UDS.

### Embedded решение

RealtimeMatches сервер оформляем как dll/so который встраиваем в UDS.

"+"

- быстрый обмен данными между RealtimeMatches сервером и UDS;
- простая поддержка в kubernetes.

"-"

- прикладной сервер должен уметь обслуживать сразу несколько матчей, так как иначе прийдется запускать по одному
  pod в kubernetes на комнату, а это очень накладно - а для UDS невозможно;
- сервера написанные на С# требуют очень вдумчивого отношения к памяти если подразумевается, что работать они
  будут долго - это несколько усложняет разработку;
- очень закрытое решение, например нельзя подключить два прикладных сервера к одному матчу, что практически
  делает невозможной идею расширений (как расширение можно сделать например функции отладки сервера, логирование
  команд, определенные античиты, конфигурирование на старте матча и так далее)

### Sidecar решение

RealtimeMatches сервер запускается как отдельное приложение, прикладные сервера также (может быть несколько разных
типов). При этом прикладной сервер подключается к RealtimeMatches серверу как обычный клиент по UDP, а также по gRPC для
управления и конфигурирования.

"+"

- расширяемость, можно одновременно подключить несколько серверов к одному матчу
- нет проблем с использованием UDS
- прикладные сервера могут создаваться на один матч, что упрощает их разработку - не надо искать утечки памяти и
  корректно чистить ресурсы

"-"

- сетевой обмен между RealtimeMatches и прикладным сервером, в целом проблемы тут нет, так как весь обмен идет в
  рамках локальной сети
- сложная поддержка в kubernetes

## Предварительно выбранное решение - SideCar

### Управление матчем

### Взаимодействие с игровыми объектами

Для работы с игровыми объектами прикладной сервер подключается как обычный клиент, но с неограниченными правами.

- может получать изменения данных по-всем объектам (входит во все группы)
- может изменять любые поля объектов
- может удалять любые объекты

### Администрирование матча

Администрирование матча (операции, которые не доступны обычному клиенту) осуществляются с помощью gRPC сервиса.

- запрет/разрешение пересылку событий от клиента другим клиентом - в данном режиме
  только прикладной сервер решает пересылать ли дальше событие
- подписка на определенные события, с определенной частотой - например, не обрабатывает каждое Move событие, а
  только N из них - для снижения нагрузки;
- завершение матча;
- удаление игрока из матча;
- конфигурирование прав доступа к объектам/полям;

### Локальная разработка (вариант с Unity Dedicated Server)

- запускаем сервисы платформы (docker из Unity);
- через Matchmaking получаем адрес RealtimeMatches и номер комнаты для входа;
- используя gRPC сервис создаем супер-пользователя в комнате;
- зная параметры супер-пользователя и адрес RealtimeMatches создаем UDP соединение;
- UDS можно запускать прямо в том же экземпляре Unity в котором запущен игровой клиент, что
  удобно - не надо держать две Unity, однако такая возможность зависит от архитектуры игры, на сколько правильно
  сделана изоляция данный UDS и игрока;

### Хостинг

- используем sidecar для запуска прикладного сервера рядом с RealtimeMatches;
- для UDS используем отдельное приложение, которое для каждой новой комнате в RealtimeMatches создает новый
  экземпляр UDS с необходимыми данными для подключения;
- UDS сервер должен быть подключенным до входа первого игрока, иначе некоторые команды могу успеть выполнится до 
  конфигурирования матча;




