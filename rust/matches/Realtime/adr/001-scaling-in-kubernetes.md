# Масштабирование relay серверов в kubernetes кластере.

## Статус

Принят

## Контекст и постановка проблемы

Relay сервер не может самостоятельно запускаться в нужном количестве. Необходима внешняя система, которая позволит в
зависимости от нагрузки управлять количеством экземпляров в kubernetes кластере, как в сторону увеличения, так и в
сторону уменьшения. Также нужна настройка сети kubernertes для запущенных серверов. В идеале нужны средства мониторинга
и контроля процесса масштабирования.

## Обзор вариантов решений

### Самостоятельная разработка

Самостоятельно разработать оператор для kubernetes для управления масштабированием. В целом это позволит нам сделать
решение, заточенное под наши нужды. Однако это займет достаточное количество времени и сил и отвлечет ресурсы от
основной задачи. В итоге не факт, что получится лучше.

### Готовое решение (https://agones.dev)

Сообществом (в основном Google & Ubisoft и другие) разработан оператор kubernetes для управления игровыми серверами.
Код представлен под OpenSource лицензией Apache License 2.0, что позволяет нам его свободно использовать.

#### Возможности

- Scaling in и scaling out. Agones запускает новые игровые сервера когда их недостаточно и удаляет неиспользуемые, когда
  их слишком много. Это отлично работает вместе с autoscaling самого кластера, когда новые Node добавляются из облака по
  запросу.
- Agones гарантирует, что GameServer к которым подключены игроки не будут выключены в середине боя при деплое или
  scale-in kubernetes кластера.
- Agones следит за доступностью GameServer и удаляет сломанные GameServer, которые не репортят свой Health статус
  вовремя, например когда GameServer завис, упал, перегружен или проблемы на Node
- Agones позволяет использовать несколько кластеров (Fleet) GameServer с разными версиями. Это удобно в ситуациях:
    - Canary релиз новой версии
    - Для совместимости с клиентами нужно иметь кластеры на старой и новой версии

## Выбранное решение

Так как agones полностью закрывает наши потребности, то выбираем его. 

### Плюсы
- не тратим время на разработку
- проверенное временем решение с нужным нам функционалом
- есть SDK для Rust

### Минусы
- работает только в kubernetes, для локальной разработки прийдется использовать Fake сервисы
- возможные ошибки/проблемы при эксплуатации нельзя будет быстро устранить, так как мы не владеем кодовой базой.

## План внедрения

- Запускаем agones в minikube
- Запускаем agones в kubernetes кластере (через единый helm)
- Интегрируем Agones SDK в Relay сервер
- Реализуем простой Registry для проверки работоспособности всей схемы.
