# Просмотр команд relay сервера из Unity для отладки

## Статус

Принят

## Контекст и постановка проблемы

Для понимания происходящего между клиентом и сервером и поиска ошибок необходимы инструменты отладки, одним из таких
инструментов может быть возможность посмотреть и провести анализ потока команд между клиентом и сервером.

## Обзор вариантов решений

- Отображение через консольную утилиту
- Отображение через браузер
- Отображение в редакторе Unity

## Выбранное решение

Так как есть гипотеза, что удобнее работать не выходя из Unity - то принимаем решение использовать Unity UI для
отображения команд. Это также (в теории) позволит провести интеграцию с другими инструментами в Unity, но пока не
понятно с какими.

## Детали решения

### Состав команды

- комната
- пользователь
- направление (user->server, server->user)
- объект (шаблон + id)
- команда
- данные команды

### Фильтрация

Так как команд много, то необходим язык фильтрации.

```
field=10 && template=20 && (user=33 || user=55)
```

### Раскрытие данных о сущностях

Relay сервер оперирует числовыми идентификаторами для команд/шаблонов и групп. Что оправданно в качестве мере снижения
трафика и быстродействия. Однако человеку сложно сопоставлять идентификаторы с игровыми сущностями. Поэтому нужен
механизм отображения текстовых названий сущностей вместо чисел.

Все нужная информация есть у сервиса Factory в конфигурации комнат. Формат конфигурации предусматривает опциональное
задание имен сущностей, однако если имя задано - то Factory может выдать эту информацию через grpc сервис.

Второй вариант - брать информацию из текущего Unity проекта, но как мне кажется не самый оптимальный вариант, так как
она может различаться с информацией на сервере. Плюс к этому еще нет понимания middle level Relay клиента, из которого
можно было вытащить дополнительные данные. То есть не откидываем данный вариант, но и не используем его в текущем
моменте.

### Возможности панели в Unity

- отображение списка команд в табличном виде, с возможностью настраивать количество столбцов
- ввод и применения фильтра
- навигация по истории фильтров
- выгрузка и загрузка команд из файла (но скорее всего не из csv, так как есть дополнительная информацию по раскрытию
  имен сущностей)

### Сбор информации на сервере

- если нет запросов на трейсы - то сбор информации не ведется
- для получения команд необходимо создать сессию - CreateSession(), в рамках сессии вызывать метод SetFilter(session,
  filter) и GetCommands(session), метод GetCommands необходимо вызывать периодически
- сессия накапливает нефильтрованные команды (размер буфера ограничен - 5-7 минут для 10 клиентов в битве),
  переустановка фильтра приводит к повторной фильтрации накопленных команд, что позволяет исследовать уже полученные
  команды
